import{r as e}from"./rope-sequence-46722072.js";import{M as t}from"./prosemirror-transform-c2f93e29.js";import{P as n,a as s}from"./prosemirror-state-5b4308dd.js";class r{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(0==this.eventCount)return null;let n,s,p=this.items.length;for(;;p--){if(this.items.get(p-1).selection){--p;break}}t&&(n=this.remapping(p,this.items.length),s=n.maps.length);let o,a,l=e.tr,m=[],h=[];return this.items.forEach(((e,t)=>{if(!e.step)return n||(n=this.remapping(p,t+1),s=n.maps.length),s--,void h.push(e);if(n){h.push(new i(e.map));let t,r=e.step.map(n.slice(s));r&&l.maybeStep(r).doc&&(t=l.mapping.maps[l.mapping.maps.length-1],m.push(new i(t,void 0,void 0,m.length+h.length))),s--,t&&n.appendMap(t,s)}else l.maybeStep(e.step);return e.selection?(o=n?e.selection.map(n.slice(s)):e.selection,a=new r(this.items.slice(0,p).append(h.reverse().concat(m)),this.eventCount-1),!1):void 0}),this.items.length,0),{remaining:a,transform:l,selection:o}}addTransform(e,t,n,s){let p=[],a=this.eventCount,l=this.items,m=!s&&l.length?l.get(l.length-1):null;for(let r=0;r<e.steps.length;r++){let n,o=e.steps[r].invert(e.docs[r]),h=new i(e.mapping.maps[r],o,t);(n=m&&m.merge(h))&&(h=n,r?p.pop():l=l.slice(0,l.length-1)),p.push(h),t&&(a++,t=void 0),s||(m=h)}let h=a-n.depth;return h>o&&(l=function(e,t){let n;return e.forEach(((e,s)=>{if(e.selection&&0==t--)return n=s,!1})),e.slice(n)}(l,h),a-=h),new r(l.append(p),a)}remapping(e,n){let s=new t;return this.items.forEach(((t,n)=>{let r=null!=t.mirrorOffset&&n-t.mirrorOffset>=e?s.maps.length-t.mirrorOffset:void 0;s.appendMap(t.map,r)}),e,n),s}addMaps(e){return 0==this.eventCount?this:new r(this.items.append(e.map((e=>new i(e)))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let n=[],s=Math.max(0,this.items.length-t),p=e.mapping,o=e.steps.length,a=this.eventCount;this.items.forEach((e=>{e.selection&&a--}),s);let l=t;this.items.forEach((t=>{let s=p.getMirror(--l);if(null==s)return;o=Math.min(o,s);let r=p.maps[s];if(t.step){let o=e.steps[s].invert(e.docs[s]),m=t.selection&&t.selection.map(p.slice(l+1,s));m&&a++,n.push(new i(r,o,m))}else n.push(new i(r))}),s);let m=[];for(let r=t;r<o;r++)m.push(new i(p.maps[r]));let h=this.items.slice(0,s).append(m).append(n),u=new r(h,a);return u.emptyItemCount()>500&&(u=u.compress(this.items.length-n.length)),u}emptyItemCount(){let e=0;return this.items.forEach((t=>{t.step||e++})),e}compress(t=this.items.length){let n=this.remapping(0,t),s=n.maps.length,p=[],o=0;return this.items.forEach(((e,r)=>{if(r>=t)p.push(e),e.selection&&o++;else if(e.step){let t=e.step.map(n.slice(s)),r=t&&t.getMap();if(s--,r&&n.appendMap(r,s),t){let a=e.selection&&e.selection.map(n.slice(s));a&&o++;let l,m=new i(r.invert(),t,a),h=p.length-1;(l=p.length&&p[h].merge(m))?p[h]=l:p.push(m)}}else e.map&&s--}),this.items.length,0),new r(e.from(p.reverse()),o)}}r.empty=new r(e.empty,0);class i{constructor(e,t,n,s){this.map=e,this.step=t,this.selection=n,this.mirrorOffset=s}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new i(t.getMap().invert(),t,this.selection)}}}class p{constructor(e,t,n,s){this.done=e,this.undone=t,this.prevRanges=n,this.prevTime=s}}const o=20;function a(e){let t=[];return e.forEach(((e,n,s,r)=>t.push(s,r))),t}function l(e,t){if(!e)return null;let n=[];for(let s=0;s<e.length;s+=2){let r=t.map(e[s],1),i=t.map(e[s+1],-1);r<=i&&n.push(r,i)}return n}function m(e,t,n,s){let r=g(t),i=d.get(t).spec.config,o=(s?e.undone:e.done).popEvent(t,r);if(!o)return;let a=o.selection.resolve(o.transform.doc),l=(s?e.done:e.undone).addTransform(o.transform,t.selection.getBookmark(),i,r),m=new p(s?l:o.remaining,s?o.remaining:l,null,0);n(o.transform.setSelection(a).setMeta(d,{redo:s,historyState:m}).scrollIntoView())}let h=!1,u=null;function g(e){let t=e.plugins;if(u!=t){h=!1,u=t;for(let e=0;e<t.length;e++)if(t[e].spec.historyPreserveItems){h=!0;break}}return h}const d=new n("history"),c=new n("closeHistory");function f(e={}){return e={depth:e.depth||100,newGroupDelay:e.newGroupDelay||500},new s({key:d,state:{init:()=>new p(r.empty,r.empty,null,0),apply:(t,n,s)=>function(e,t,n,s){let i,o=n.getMeta(d);if(o)return o.historyState;n.getMeta(c)&&(e=new p(e.done,e.undone,null,0));let m=n.getMeta("appendedTransaction");if(0==n.steps.length)return e;if(m&&m.getMeta(d))return m.getMeta(d).redo?new p(e.done.addTransform(n,void 0,s,g(t)),e.undone,a(n.mapping.maps[n.steps.length-1]),e.prevTime):new p(e.done,e.undone.addTransform(n,void 0,s,g(t)),null,e.prevTime);if(!1===n.getMeta("addToHistory")||m&&!1===m.getMeta("addToHistory"))return(i=n.getMeta("rebased"))?new p(e.done.rebased(n,i),e.undone.rebased(n,i),l(e.prevRanges,n.mapping),e.prevTime):new p(e.done.addMaps(n.mapping.maps),e.undone.addMaps(n.mapping.maps),l(e.prevRanges,n.mapping),e.prevTime);{let i=0==e.prevTime||!m&&(e.prevTime<(n.time||0)-s.newGroupDelay||!function(e,t){if(!t)return!1;if(!e.docChanged)return!0;let n=!1;return e.mapping.maps[0].forEach(((e,s)=>{for(let r=0;r<t.length;r+=2)e<=t[r+1]&&s>=t[r]&&(n=!0)})),n}(n,e.prevRanges)),o=m?l(e.prevRanges,n.mapping):a(n.mapping.maps[n.steps.length-1]);return new p(e.done.addTransform(n,i?t.selection.getBookmark():void 0,s,g(t)),r.empty,o,n.time)}}(n,s,t,e)},config:e,props:{handleDOMEvents:{beforeinput(e,t){let n=t.inputType,s="historyUndo"==n?v:"historyRedo"==n?w:null;return!!s&&(t.preventDefault(),s(e.state,e.dispatch))}}}})}const v=(e,t)=>{let n=d.getState(e);return!(!n||0==n.done.eventCount)&&(t&&m(n,e,t,!1),!0)},w=(e,t)=>{let n=d.getState(e);return!(!n||0==n.undone.eventCount)&&(t&&m(n,e,t,!0),!0)};function y(e){let t=d.getState(e);return t?t.done.eventCount:0}export{y as a,f as h,w as r,v as u};
